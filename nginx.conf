# =================================================================
# Search-2api - ç»ˆæç²˜æ€§ä¼šè¯ä¸æ€§èƒ½ç‰ˆ Nginx é…ç½®
# æ ¸å¿ƒ: é‡‡ç”¨æœ€å¥å£®çš„ä¼šè¯ä¿æŒç­–ç•¥ï¼Œç¡®ä¿æµå¼å“åº”ç¨³å®š
# =================================================================

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # --- ä¸Šæ¸¸æœåŠ¡å™¨ç»„ (æˆ‘ä»¬çš„ FastAPI å·¥äºº) ---
    upstream search_backend {
        # å…³é”®ä¿®æ­£ ğŸš€: ä½¿ç”¨ Cookie è¯·æ±‚å¤´è¿›è¡Œå“ˆå¸Œï¼Œå®ç°â€œç»ˆæç²˜æ€§ä¼šè¯â€
        # è¿™ç¡®ä¿äº†æºå¸¦ç›¸åŒ Cookie çš„è¯·æ±‚æ€»æ˜¯å‘½ä¸­åŒä¸€ä¸ªåç«¯å®ä¾‹ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³ä¼šè¯é—®é¢˜ã€‚
        hash $http_cookie consistent;

        # ä¿¡ä»»ç­–ç•¥: ç›´æ¥è¿æ¥åˆ°åç«¯æœåŠ¡
        server app:8000;
    }

    # --- ä¸»æœåŠ¡å™¨é…ç½® (API ç½‘å…³) ---
    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://search_backend;

            # --- æµå¼ä¼ è¾“ç»ˆæä¼˜åŒ– ---
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;

            # --- æ ‡å‡†å¤´ä¿¡æ¯è½¬å‘ ---
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
